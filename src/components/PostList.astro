---
import { Picture } from "astro:assets";
import { getCollection } from "astro:content";
import YouTubeVideo from "./YouTubeVideo.astro";
import { AUTHOR_NAME } from "~/consts";
import { slugRewrite } from "~/util";

interface Props {
  limit?: number
  page?: boolean
  tag?: string
}

const {
  limit = 20,
  tag
  // page = true
} = Astro.props;

const posts = (await getCollection("blog"))
  .map(slugRewrite)
  .filter((post: any) => tag ? post.data.tags?.includes(tag) : true)
  .sort(
    (a, b) => b.data.publishedOn.valueOf() - a.data.publishedOn.valueOf(),
  )
  .slice(0, limit);
---

<ul class="unlist flex-column flex-gap-16">
  {posts.map((post) => {
    const url = new URL(`/blog/${post.slug}`, Astro.url.origin);
    return (
      <li>
        <article class="flex-column flex-gap-16" role="link" data-href={url}>
          {post.data.video && (
            <YouTubeVideo videoId={post.data.video.id} videoTitle={post.data.title} />
          )}
          {!post.data.video && post.data.image && (
            <Picture
              src={post.data.image}
              alt={post.data.title}
              formats={["webp"]}
            />
          )}
          <h3>
            <a href={url} class="unlink">
              {post.data.title}
            </a>
          </h3>
          <div class="flex flex-gap-8 flex-wrap">
            <time datetime={post.data.publishedOn.toISOString()} to-rel
                data-tooltip={post.data.publishedOn.toLocaleString()}>
              {post.data.publishedOn.toLocaleDateString()}
            </time>
            â€¢
            <a href={new URL("about", Astro.url.origin)} class="unlink" title={AUTHOR_NAME}>{AUTHOR_NAME}</a>
          </div>
          <ul class="unlist flex flex-gap-8 flex-wrap">
            {post.data.tags?.map((tag) => (
              <li>
                <a href={new URL(`/blog/tags/${tag}`, Astro.url.origin)} class="secondary">#{tag}</a>
              </li>
            ))}
          </ul>
          <div class="post-description">
            {post.data.description}
          </div>
          <a href={url}>
            Read more &gt;&gt;
          </a>
        </article>
      </li>
    )
  })
}
</ul>

